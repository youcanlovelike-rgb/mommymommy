name: Build Mommy Real Core
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ æ‹‰å–æºç  (åŒ…å«æ·±åº¦å­æ¨¡å—)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ğŸš€ é‡Šæ”¾ä¸å¢å¼ºå†…å­˜ (å…¨åŠ›å†²åˆº 7GB+)
        run: |
          # å¸è½½å†—ä½™è½¯ä»¶ï¼Œè…¾å‡ºç‰©ç†å†…å­˜ç©ºé—´
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-31
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-30
          # å¼€å¯ 2GB Swap è™šæ‹Ÿå†…å­˜
          sudo swapoff -a
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: ğŸ’‰ å¼ºåˆ¶æ›¿æ¢åŒ…å (Mommy ä¸“å±è¡€ç»Ÿ)
        run: |
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org.drinkless.tdlib/org.mommy.messenger/g' {} +
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org_drinkless_tdlib/org_mommy_messenger/g' {} +
          echo "âœ… åŒ…åæ›¿æ¢å·²å®Œæˆ"

      - name: ğŸ› ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gperf php-cli ninja-build

      - name: ğŸ” è·å–å¹¶å‡†å¤‡ Android ä¸“ç”¨ OpenSSL
        run: |
          # ä¸‹è½½é¢„ç¼–è¯‘å¥½çš„é™æ€åº“
          git clone https://github.com/KDAB/android_openssl.git ${GITHUB_WORKSPACE}/android_openssl

      - name: ğŸ—ï¸ æ‰§è¡Œå…¨åŠŸèƒ½ç¼–è¯‘ (arm64-v8a)
        run: |
          mkdir build && cd build
          
          # å®šä¹‰ OpenSSL æ¶æ„è·¯å¾„å˜é‡
          SSL_PATH="${GITHUB_WORKSPACE}/android_openssl/arm64-v8a"
          
          # é…ç½® CMake (æ‰‹åŠ¨å¼ºåˆ¶æŒ‡å®š OpenSSL è·¯å¾„)
          cmake -G Ninja \
                -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_LATEST_HOME}/build/cmake/android.toolchain.cmake \
                -DANDROID_ABI=arm64-v8a \
                -DANDROID_PLATFORM=android-24 \
                -DTD_ENABLE_JNI=ON \
                -DCMAKE_BUILD_TYPE=Release \
                -DOPENSSL_USE_STATIC_LIBS=TRUE \
                -DOPENSSL_INCLUDE_DIR=${SSL_PATH}/include \
                -DOPENSSL_CRYPTO_LIBRARY=${SSL_PATH}/lib/libcrypto.a \
                -DOPENSSL_SSL_LIBRARY=${SSL_PATH}/lib/libssl.a \
                -DCMAKE_INSTALL_PREFIX:PATH=../td_install \
                ..

          # 1. é¢„ç”Ÿæˆä»£ç ï¼Œè§£å†³ [42/90] æŠ¥é”™é—®é¢˜
          ninja td_generate_mime_types
          
          # 2. æ­£å¼å¼€å§‹å…¨é‡ç¼–è¯‘ï¼Œä½¿ç”¨ -j2 ç¡®ä¿ 7G å†…å­˜ä¸æº¢å‡º
          ninja -j2 install

      - name: ğŸ“¦ ä¸Šä¼ æˆå“ libtdjni.so
        uses: actions/upload-artifact@v4
        with:
          name: mommy-real-so-arm64
          path: td_install/lib/libtdjni.so

