name: Build Mommy Full Real Core
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ æ‹‰å–æºç 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸš€ å¢å¼ºå†…å­˜ä¸ Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: ğŸ’‰ åŒ…åå…¨å±€æ›¿æ¢
        run: |
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org.drinkless.tdlib/org.mommy.messenger/g' {} +
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org_drinkless_tdlib/org_mommy_messenger/g' {} +

      - name: ğŸ› ï¸ è‡ªåŠ¨åŒ–æ„å»º (Docker æ¨¡å¼ - é¿å¼€è·¯å¾„ Size æ£€æŸ¥)
        run: |
          git clone https://github.com/KDAB/android_openssl.git ../android_openssl
          
          cat << 'EOF' > build_script.sh
          set -e
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y cmake gperf php-cli ninja-build clang git libssl-dev zlib1g-dev openjdk-11-jdk
          export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
          
          # 1. ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘ç”Ÿæˆå™¨
          mkdir -p build_local && cd build_local
          cmake -G Ninja -DTD_ENABLE_JNI=ON ..
          ninja td_generate_java_api
          
          # ã€å½»åº•ä¿®å¤ Wrong Size æŠ¥é”™ã€‘
          # ä¸è¦é¢„å…ˆåˆ›å»ºç›®å½•ï¼è®©ç”Ÿæˆå™¨è‡ªå·±å»åˆ›å»ºä¸å­˜åœ¨çš„è·¯å¾„
          # æˆ‘ä»¬æŠŠè¾“å‡ºæŒ‡å‘å®¹å™¨å†…éƒ¨éæŒ‚è½½è·¯å¾„ /tmp/gen
          rm -rf /tmp/gen_telegram /tmp/gen_mtproto
          ./td/generate/td_generate_java_api ../td/telegram/td_api.tl /tmp/gen_telegram/ ../td/mtproto/mtproto_api.tl /tmp/gen_mtproto/
          
          # MIME ç”Ÿæˆ
          mkdir -p /tmp/gen_utils
          php ../tdutils/generate/generate_mime_types_gperf.php ../tdutils/generate/mime_types.list /tmp/gen_utils/mime_type_to_extension.cpp
          cd ..

          # 2. æ·±åº¦è·¯å¾„å¯¹é½ (æŠŠç”Ÿå¥½çš„ä¸œè¥¿æ¬è¿åˆ° Android ç¼–è¯‘å™¨é¢„æœŸçš„ä½ç½®)
          # åˆ›å»ºç¼–è¯‘å™¨ä¸€å®šä¼šå»æ‰¾çš„é‚£ä¸ªç”Ÿæˆè·¯å¾„
          GEN_DIR="build_android/td/generate/auto"
          mkdir -p "$GEN_DIR/td/telegram"
          mkdir -p "$GEN_DIR/td/mtproto"
          mkdir -p "build_android/tdutils/generate/auto"

          cp -fv /tmp/gen_telegram/* "$GEN_DIR/td/telegram/" || true
          cp -fv /tmp/gen_mtproto/* "$GEN_DIR/td/mtproto/" || true
          cp -fv /tmp/gen_utils/* "build_android/tdutils/generate/auto/" || true

          # 3. ç¬¬äºŒé˜¶æ®µï¼šAndroid äº¤å‰ç¼–è¯‘
          cd build_android
          CRYPTO_PATH=$(find /android_openssl -name "libcrypto.a" | grep "arm64-v8a" | head -n 1)
          SSL_PATH=$(find /android_openssl -name "libssl.a" | grep "arm64-v8a" | head -n 1)
          SSL_INC=$(dirname $(dirname $CRYPTO_PATH))/include

          cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_LATEST_HOME}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DTD_ENABLE_JNI=ON \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DOPENSSL_INCLUDE_DIR="$SSL_INC" \
            -DOPENSSL_CRYPTO_LIBRARY="$CRYPTO_PATH" \
            -DOPENSSL_SSL_LIBRARY="$SSL_PATH" \
            -DCMAKE_INSTALL_PREFIX:PATH=/td_install \
            ..
          
          # é”å®šæ—¶é—´æˆ³ï¼Œé˜²æ­¢ CMake å†æ¬¡è§¦å‘é‚£ä¸ªä¼šæŠ¥é”™çš„ç”Ÿæˆé€»è¾‘
          find . -type f -exec touch {} +
          ninja -j2 install
          EOF

          docker run --rm \
            -v $(pwd):/work \
            -v ${GITHUB_WORKSPACE}/../android_openssl:/android_openssl \
            -v ${ANDROID_NDK_LATEST_HOME}:${ANDROID_NDK_LATEST_HOME} \
            -e ANDROID_NDK_LATEST_HOME=${ANDROID_NDK_LATEST_HOME} \
            -e DEBIAN_FRONTEND=noninteractive \
            -w /work \
            ubuntu:22.04 /bin/bash build_script.sh

      - name: ğŸ“¦ ä¸Šä¼ æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: mommy-full-real-core
          path: td_install/lib/libtdjni.so

