name: Build Mommy Real Core (Full Features)
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ æ‹‰å–æºç 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸš€ å¢å¼ºå†…å­˜ä¸ Swap (å…¨åŠŸèƒ½ç¼–è¯‘éœ€è¦æå¤§å†…å­˜)
        run: |
          sudo swapoff -a
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: ğŸ’‰ åŒ…åå…¨å±€æ›¿æ¢ (ç¡®ä¿ JNI ç­¾åå”¯ä¸€)
        run: |
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org.drinkless.tdlib/org.mommy.messenger/g' {} +
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org_drinkless_tdlib/org_mommy_messenger/g' {} +

      - name: ğŸ› ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gperf php-cli ninja-build clang

      - name: ğŸ” é”å®š OpenSSL (å…¨åŠŸèƒ½è¿æ¥å¿…é¡»)
        run: |
          git clone https://github.com/KDAB/android_openssl.git ../android_openssl
          CRYPTO_PATH=$(find ${GITHUB_WORKSPACE}/../android_openssl -name "libcrypto.a" | grep "arm64-v8a" | head -n 1)
          SSL_PATH=$(find ${GITHUB_WORKSPACE}/../android_openssl -name "libssl.a" | grep "arm64-v8a" | head -n 1)
          echo "CRYPTO_LIB=$CRYPTO_PATH" >> $GITHUB_ENV
          echo "SSL_LIB=$SSL_PATH" >> $GITHUB_ENV
          echo "SSL_INC=$(dirname $(dirname $CRYPTO_PATH))/include" >> $GITHUB_ENV

      - name: ğŸ—ï¸ æ ¸å¿ƒçªç ´ï¼šå…¨é‡ API çµé­‚æ³¨å…¥
        run: |
          # 1. å¼ºåˆ¶åœ¨æºç ç›®å½•åˆ›å»ºæ‰€æœ‰é¢„æœŸçš„è·¯å¾„
          mkdir -p td/generate/auto/td/telegram
          mkdir -p td/generate/auto/td/mtproto
          mkdir -p tdutils/generate/auto

          # 2. æœ¬åœ°è½»é‡åŒ–ç”Ÿæˆï¼ˆåªä¸ºäº†æ‹¿åˆ°é‚£ 100 å¤šä¸ª .cpp æ–‡ä»¶ï¼‰
          mkdir -p build_local && cd build_local
          cmake -G Ninja -DTD_ENABLE_JNI=ON ..
          # è¿™ä¸€æ­¥ä¼šçœŸæ­£ç”ŸæˆçœŸæ­£çš„ td_api_x.cpp
          ninja td_api_generate_cpp || echo "Ignore link errors"
          cd ..

          # 3. ç‰©ç†æ¬è¿ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿æ–‡ä»¶åˆ°ä½ï¼‰
          # æˆ‘ä»¬æŠŠç”Ÿæˆå™¨åå‡ºæ¥çš„æ‰€æœ‰çœŸä»£ç ï¼Œå…¨éƒ¨å¼ºè¡Œå¡è¿› Android ç¼–è¯‘å™¨å¿…ç»çš„è·¯å¾„
          cp -f build_local/td/generate/auto/td/telegram/td_api_* td/generate/auto/td/telegram/ || true
          cp -f build_local/td/generate/auto/td/telegram/td_api.h td/generate/auto/td/telegram/ || true
          cp -f build_local/td/generate/auto/td/mtproto/mtproto_api.* td/generate/auto/td/mtproto/ || true
          cp -f build_local/tdutils/generate/auto/mime_type_to_extension.* tdutils/generate/auto/ || true

          # 4. ã€å…³é”®æ­¥éª¤ã€‘æ¬ºéª— CMakeï¼Œè®©å®ƒä»¥ä¸ºå·²ç»ç”Ÿæˆè¿‡äº†
          # æˆ‘ä»¬åœ¨ build_android è¿˜æ²¡åˆ›å»ºæ—¶ï¼Œå…ˆåœ¨æºç é‡Œç•™ä¸‹â€œå·²å®Œæˆâ€çš„æ ‡è®°
          touch td/generate/auto/td/telegram/td_api_0.cpp

      - name: ğŸ—ï¸ æœ€ç»ˆäº¤å‰ç¼–è¯‘ (å…¨åŠŸèƒ½æ”¶å‰²)
        env:
          INC: ${{ env.SSL_INC }}
          CRYPTO: ${{ env.CRYPTO_LIB }}
          SSL: ${{ env.SSL_LIB }}
        run: |
          mkdir -p build_android && cd build_android
          # è¿™é‡Œçš„å…³é”®ï¼šè®¾ç½® -DTD_GENERATE_API=OFFï¼Œå¼ºåˆ¶ä¸è®©å®ƒå»å°è¯•è¿è¡Œç”Ÿæˆå™¨
          cmake -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_LATEST_HOME}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DTD_ENABLE_JNI=ON \
            -DTD_GENERATE_API=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DOPENSSL_USE_STATIC_LIBS=TRUE \
            -DOPENSSL_INCLUDE_DIR="$INC" \
            -DOPENSSL_CRYPTO_LIBRARY="$CRYPTO" \
            -DOPENSSL_SSL_LIBRARY="$SSL" \
            -DCMAKE_INSTALL_PREFIX:PATH=../td_install \
            ..
          
          # ç‰©ç†åŒæ­¥æ—¶é—´æˆ³ï¼Œé˜²æ­¢ Ninja æŠ½é£
          find .. -type f -exec touch {} +
          
          # æ­£å¼å…¨é‡ç¼–è¯‘
          ninja -j2 install

      - name: ğŸ“¦ ä¸Šä¼ æˆå“ libtdjni.so
        uses: actions/upload-artifact@v4
        with:
          name: mommy-full-real-core
          path: td_install/lib/libtdjni.so

