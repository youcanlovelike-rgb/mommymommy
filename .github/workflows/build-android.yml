name: Build Mommy Real Core
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ æ‹‰å–æºç 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸš€ å¢å¼ºè¿è¡Œå†…å­˜ (7GB RAM + 2GB Swap)
        run: |
          sudo swapoff -a
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: ğŸ’‰ ä¿®æ”¹åŒ…åä¸º Mommy ä¸“å±
        run: |
          grep -rl "org.drinkless.tdlib" . | xargs sed -i 's/org.drinkless.tdlib/org.mommy.messenger/g' || true
          grep -rl "org_drinkless_tdlib" . | xargs sed -i 's/org_drinkless_tdlib/org_mommy_messenger/g' || true

      - name: ğŸ› ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gperf php-cli ninja-build

      - name: ğŸ” å¼•å…¥ Android ä¸“ç”¨ OpenSSL
        run: |
          git clone https://github.com/KDAB/android_openssl.git ../android_openssl

      - name: ğŸ—ï¸ æ‰§è¡Œå…¨åŠŸèƒ½ç¼–è¯‘ (é™åˆ¶å¹¶å‘ä»¥é˜²å´©æºƒ)
        run: |
          mkdir build && cd build
          cmake -G Ninja \
                -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_LATEST_HOME}/build/cmake/android.toolchain.cmake \
                -DANDROID_ABI=arm64-v8a \
                -DANDROID_PLATFORM=android-24 \
                -DTD_ENABLE_JNI=ON \
                -DCMAKE_BUILD_TYPE=Release \
                -DOPENSSL_USE_STATIC_LIBS=TRUE \
                -DCMAKE_INSTALL_PREFIX:PATH=../td_install \
                ..
          # ä½¿ç”¨ -j2 é™åˆ¶å¹¶å‘æ•°ã€‚è™½ç„¶æ¯” -j4 æ…¢ä¸€ç‚¹ç‚¹ï¼Œ
          # ä½†èƒ½ä¿è¯åœ¨ 7GB å†…å­˜ä¸‹ç»å¯¹ä¸ä¼šå› ä¸ºå†…å­˜æº¢å‡ºè€Œç¼–è¯‘å¤±è´¥ã€‚
          ninja -j2 install

      - name: ğŸ“¦ ä¸Šä¼ æˆå“ libtdjni.so
        uses: actions/upload-artifact@v4
        with:
          name: mommy-real-so-arm64
          path: td_install/lib/libtdjni.so

