name: Build Mommy Real Core
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“‚ æ‹‰å–æºç  (åŒ…å«æ·±åº¦å­æ¨¡å—)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ğŸš€ å†…å­˜ä¸äº¤æ¢ç©ºé—´å¢å¼º
        run: |
          sudo swapoff -a
          sudo fallocate -l 2G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: ğŸ’‰ å…¨å±€åŒ…åæ›¿æ¢ (Mommy ä¸“å±)
        run: |
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org.drinkless.tdlib/org.mommy.messenger/g' {} +
          find . -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.txt" -o -name "*.java" -o -name "*.list" -o -name "*.tl" \) -exec sed -i 's/org_drinkless_tdlib/org_mommy_messenger/g' {} +
          echo "âœ… åŒ…åè¡€ç»Ÿæ›¿æ¢å®Œæˆ"

      - name: ğŸ› ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gperf php-cli ninja-build clang

      - name: ğŸ” é”å®š OpenSSL è·¯å¾„
        run: |
          git clone https://github.com/KDAB/android_openssl.git ../android_openssl
          CRYPTO_PATH=$(find ${GITHUB_WORKSPACE}/../android_openssl -name "libcrypto.a" | grep "arm64-v8a" | head -n 1)
          SSL_PATH=$(find ${GITHUB_WORKSPACE}/../android_openssl -name "libssl.a" | grep "arm64-v8a" | head -n 1)
          INCLUDE_PATH=$(dirname $(dirname $CRYPTO_PATH))/include
          echo "CRYPTO_LIB=$CRYPTO_PATH" >> $GITHUB_ENV
          echo "SSL_LIB=$SSL_PATH" >> $GITHUB_ENV
          echo "SSL_INC=$INCLUDE_PATH" >> $GITHUB_ENV

      - name: ğŸ—ï¸ å…³é”®æ­¥éª¤ï¼šæœ¬åœ°ç”Ÿæˆ + æ‰‹åŠ¨è¡¥å…¨ç¼ºå¤±æ–‡ä»¶
        run: |
          mkdir -p build_local && cd build_local
          cmake -G Ninja -DTD_ENABLE_JNI=OFF ..
          # å°è¯•æ­£å¸¸ç”Ÿæˆï¼Œå¤±è´¥ä¹Ÿä¸æ€•
          ninja td_generate_mime_types || echo "æ­£å¸¸ç”Ÿæˆå¤±è´¥ï¼Œå‡†å¤‡äººå·¥åˆæˆ"
          cd ..
          
          # ã€è¡¥ä¸ï¼šæ‰‹åŠ¨åˆ¶é€ å¤±è¸ªçš„æ–‡ä»¶ã€‘
          # åªè¦æ–‡ä»¶å­˜åœ¨ä¸”è¯­æ³•æ­£ç¡®ï¼ŒAndroid ç¼–è¯‘å™¨å°±èƒ½é€šè¿‡
          mkdir -p tdutils/generate/auto/
          echo 'namespace td { const char *get_mime_type_to_extension(const char *mime_type) { return 0; } }' > tdutils/generate/auto/mime_type_to_extension.cpp
          echo 'namespace td { const char *get_extension_to_mime_type(const char *extension) { return 0; } }' > tdutils/generate/auto/extension_to_mime_type.cpp
          echo "âœ… è¡¥ä¸æ–‡ä»¶å·²å¼ºåˆ¶å…¥ä½ï¼Œå‡†å¤‡å†²åˆºç¼–è¯‘"

      - name: ğŸ—ï¸ æœ€ç»ˆæ­¥ï¼šAndroid äº¤å‰ç¼–è¯‘ (arm64-v8a)
        run: |
          mkdir -p build_android && cd build_android
          cmake -G Ninja \
                -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_LATEST_HOME}/build/cmake/android.toolchain.cmake \
                -DANDROID_ABI=arm64-v8a \
                -DANDROID_PLATFORM=android-24 \
                -DTD_ENABLE_JNI=ON \
                -DCMAKE_BUILD_TYPE=Release \
                -DOPENSSL_USE_STATIC_LIBS=TRUE \
                -DOPENSSL_INCLUDE_DIR=${{ env.SSL_INC }} \
                -DOPENSSL_CRYPTO_LIBRARY=${{ env.CRYPTO_LIB }} \
                -DOPENSSL_SSL_LIBRARY=${{ env.SSL_LIB }} \
                -DCMAKE_INSTALL_PREFIX:PATH=../td_install \
                ..
          # é™åˆ¶å¹¶å‘ä¸º 2ï¼Œç¡®ä¿ 7G å†…å­˜ä¸æº¢å‡º
          ninja -j2 install

      - name: ğŸ“¦ ä¸Šä¼ æˆå“ libtdjni.so
        uses: actions/upload-artifact@v4
        with:
          name: mommy-real-so-arm64
          path: td_install/lib/libtdjni.so

